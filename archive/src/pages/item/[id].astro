---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { getAllItems, getItemById, getRelatedItems } from '../../lib/items';
import type { Item } from '../../lib/items';

export async function getStaticPaths() {
  const items = getAllItems();
  return items.map((item) => ({
    params: { id: item.id },
    props: { item },
  }));
}

interface Props {
  item: Item;
}

const { item } = Astro.props;

const categoryLabels: Record<Item['category'], string> = {
  coin: 'Coin',
  jewelry: 'Jewelry',
  ring: 'Ring',
  seal: 'Seal',
  misc: 'Miscellaneous',
};

const allItems = getAllItems();
const currentIndex = allItems.findIndex(i => i.id === item.id);
const prevItem = currentIndex > 0 ? allItems[currentIndex - 1] : null;
const nextItem = currentIndex < allItems.length - 1 ? allItems[currentIndex + 1] : null;
const relatedItems = getRelatedItems(item, 3);
const base = import.meta.env.BASE_URL;

function url(path: string): string {
  return `${base}${path}`.replace(/\/+/g, '/');
}

const itemStructuredData = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": item.name,
  "description": item.description,
  "category": categoryLabels[item.category],
  "material": item.material,
  "image": item.images.length > 0 ? `${Astro.site || ''}${url(`/images/items/${item.id}/${item.images[0]}`)}` : undefined,
  "additionalProperty": [
    { "@type": "PropertyValue", "name": "Era", "value": item.era },
    { "@type": "PropertyValue", "name": "Period", "value": item.period },
    { "@type": "PropertyValue", "name": "Origin", "value": item.origin },
    ...(item.weight ? [{ "@type": "PropertyValue", "name": "Weight", "value": item.weight }] : []),
    ...(item.dimensions ? [{ "@type": "PropertyValue", "name": "Dimensions", "value": item.dimensions }] : []),
    ...(item.condition ? [{ "@type": "PropertyValue", "name": "Condition", "value": item.condition }] : [])
  ]
};
---

<BaseLayout title={`${item.name} | Archive`} description={item.description} structuredData={itemStructuredData}>
  <article class="relative py-16 min-h-screen" data-pagefind-body>

    <div class="container-narrow relative">
      <div data-pagefind-ignore>
        <Breadcrumb items={[
          { label: 'Collection', href: url('/collection') },
          { label: categoryLabels[item.category], href: url(`/collection?category=${item.category}`) },
          { label: item.name }
        ]} />
      </div>

      <div class="grid lg:grid-cols-2 gap-12 lg:gap-16">
        <div x-data={`{
          activeImage: 0,
          lightboxOpen: false,
          totalImages: ${item.images.length},
          openLightbox(index) {
            this.activeImage = index;
            this.lightboxOpen = true;
            document.body.style.overflow = 'hidden';
          },
          closeLightbox() {
            this.lightboxOpen = false;
            document.body.style.overflow = '';
          },
          nextImage() {
            this.activeImage = (this.activeImage + 1) % this.totalImages;
          },
          prevImage() {
            this.activeImage = (this.activeImage - 1 + this.totalImages) % this.totalImages;
          }
        }`}
        @keydown.arrow-left.window="if(lightboxOpen) prevImage(); else if(totalImages > 1) { activeImage = (activeImage - 1 + totalImages) % totalImages }"
        @keydown.arrow-right.window="if(lightboxOpen) nextImage(); else if(totalImages > 1) { activeImage = (activeImage + 1) % totalImages }"
        @keydown.escape.window="closeLightbox()"
        class="space-y-4">
          {item.images.length > 0 ? (
            <>
              <button
                @click="openLightbox(activeImage)"
                class="glass-panel overflow-hidden w-full cursor-zoom-in focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-void rounded-lg"
                aria-label="Open image in lightbox"
              >
                {item.images.map((image, index) => (
                  <img
                    x-show={`activeImage === ${index}`}
                    x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="opacity-0"
                    x-transition:enter-end="opacity-100"
                    src={url(`/images/items/${item.id}/${image}`)}
                    alt={`${item.name} - Image ${index + 1}`}
                    class="w-full h-auto"
                    loading={index === 0 ? 'eager' : 'lazy'}
                  />
                ))}
              </button>
              {item.images.length > 1 && (
                <div class="flex gap-2 overflow-x-auto pb-2">
                  {item.images.map((image, index) => (
                    <button
                      @click={`activeImage = ${index}`}
                      :class={`activeImage === ${index} ? 'ring-2 ring-accent' : 'opacity-60 hover:opacity-100'`}
                      class="flex-shrink-0 w-24 h-24 min-w-[44px] min-h-[44px] rounded overflow-hidden transition-all duration-200"
                    >
                      <img
                        src={url(`/images/items/${item.id}/${image}`)}
                        alt={`Thumbnail ${index + 1}`}
                        class="w-full h-full object-cover"
                        loading="lazy"
                      />
                    </button>
                  ))}
                </div>
              )}
            </>
          ) : (
            <div class="aspect-square glass-panel flex flex-col items-center justify-center gap-2">
              <svg class="w-12 h-12 text-text-dim" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span class="font-mono text-xs text-text-dim uppercase tracking-wider">No image available</span>
            </div>
          )}

          <!-- Lightbox Overlay -->
          <div
            x-show="lightboxOpen"
            x-cloak
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 z-[100] bg-void/95 backdrop-blur-xl flex items-center justify-center"
            @click.self="closeLightbox()"
            role="dialog"
            aria-modal="true"
            aria-label="Image lightbox"
          >
            <!-- Close button -->
            <button
              @click="closeLightbox()"
              class="absolute top-4 right-4 p-2 text-text-muted hover:text-accent transition-colors z-10"
              aria-label="Close lightbox"
            >
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>

            <!-- Previous button -->
            {item.images.length > 1 && (
              <button
                @click="prevImage()"
                class="absolute left-4 top-1/2 -translate-y-1/2 p-3 text-text-muted hover:text-accent transition-colors z-10"
                aria-label="Previous image"
              >
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
              </button>
            )}

            <!-- Next button -->
            {item.images.length > 1 && (
              <button
                @click="nextImage()"
                class="absolute right-4 top-1/2 -translate-y-1/2 p-3 text-text-muted hover:text-accent transition-colors z-10"
                aria-label="Next image"
              >
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            )}

            <!-- Image container -->
            <div class="max-w-[90vw] max-h-[90vh] relative">
              {item.images.map((image, index) => (
                <img
                  x-show={`activeImage === ${index}`}
                  x-transition:enter="transition ease-out duration-300"
                  x-transition:enter-start="opacity-0 scale-95"
                  x-transition:enter-end="opacity-100 scale-100"
                  src={url(`/images/items/${item.id}/${image}`)}
                  alt={`${item.name} - Image ${index + 1}`}
                  class="max-w-full max-h-[85vh] object-contain"
                />
              ))}
            </div>

            <!-- Image counter -->
            {item.images.length > 1 && (
              <div class="absolute bottom-4 left-1/2 -translate-x-1/2 font-mono text-sm text-text-muted">
                <span x-text="activeImage + 1"></span> / {item.images.length}
              </div>
            )}

            <!-- Keyboard hint -->
            <div class="absolute bottom-4 right-4 font-mono text-xs text-text-dim hidden md:block">
              ← → navigate · ESC close
            </div>
          </div>
        </div>

        <div class="lg:sticky lg:top-24 lg:self-start">
          <div class="flex items-center gap-2 mb-4">
            <span class="font-mono text-xs uppercase tracking-wider text-accent">
              {categoryLabels[item.category]}
            </span>
            <span class="text-text-dim">·</span>
            <span class="font-mono text-xs uppercase tracking-wider text-text-dim">
              {item.period}
            </span>
          </div>

          <h1 class="text-3xl md:text-4xl text-text mb-6" data-pagefind-meta="title">{item.name}</h1>
          <span data-pagefind-meta={`category:${categoryLabels[item.category]}`} class="hidden"></span>
          <span data-pagefind-meta={`period:${item.period}`} class="hidden"></span>
          <span data-pagefind-meta={`origin:${item.origin}`} class="hidden"></span>
          <span data-pagefind-meta={`material:${item.material}`} class="hidden"></span>

          <div class="glass-panel p-6 mb-8">
            <p class="text-text-muted leading-relaxed">{item.description}</p>
          </div>

          <div class="glass-panel p-6">
            <h2 class="font-mono text-xs uppercase tracking-wider text-accent mb-4">// Details</h2>

            <dl class="grid grid-cols-[auto_1fr] gap-y-3 gap-x-6">
              <dt class="data-label">Era</dt>
              <dd class="data-value text-right">{item.era}</dd>

              <dt class="data-label">Period</dt>
              <dd class="data-value text-right">{item.period}</dd>

              <dt class="data-label">Origin</dt>
              <dd class="data-value text-right">{item.origin}</dd>

              <dt class="data-label">Material</dt>
              <dd class="data-value text-right capitalize">{item.material}</dd>

              {item.weight && (
                <>
                  <dt class="data-label">Weight</dt>
                  <dd class="data-value text-right">{item.weight}</dd>
                </>
              )}

              {item.dimensions && (
                <>
                  <dt class="data-label">Dimensions</dt>
                  <dd class="data-value text-right">{item.dimensions}</dd>
                </>
              )}

              {item.condition && (
                <>
                  <dt class="data-label">Condition</dt>
                  <dd class="data-value text-right">{item.condition}</dd>
                </>
              )}
            </dl>
          </div>

          {item.tags.length > 0 && (
            <div class="glass-panel p-6 mt-4">
              <h2 class="font-mono text-xs uppercase tracking-wider text-accent mb-4">// Tags</h2>
              <div class="flex flex-wrap gap-2">
                {item.tags.map((tag) => (
                  <a
                    href={url(`/collection?tag=${encodeURIComponent(tag)}`)}
                    class="tag-chip px-3 py-1 bg-surface-light border border-border rounded font-mono text-xs text-text-muted hover:border-accent hover:text-accent transition-all duration-200"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>

      {relatedItems.length > 0 && (
        <section class="mt-20 pt-8 border-t border-border" data-pagefind-ignore>
          <h2 class="font-mono text-xs uppercase tracking-wider text-accent mb-6">// Related Items</h2>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {relatedItems.map((related) => (
              <a
                href={url(`/item/${related.id}`)}
                class="glass-panel p-4 card-hover group"
              >
                <div class="flex items-center gap-2 mb-2">
                  <span class="font-mono text-[10px] uppercase tracking-wider text-accent">
                    {categoryLabels[related.category]}
                  </span>
                  <span class="text-text-dim">·</span>
                  <span class="font-mono text-[10px] uppercase tracking-wider text-text-dim">
                    {related.period}
                  </span>
                </div>
                <h3 class="text-lg text-text group-hover:text-accent transition-colors">
                  {related.name}
                </h3>
                <p class="font-mono text-xs text-text-dim mt-1">{related.era}</p>
              </a>
            ))}
          </div>
        </section>
      )}

      <nav class="flex justify-between items-center mt-12 pt-8 border-t border-border" data-pagefind-ignore>
        {prevItem ? (
          <a href={url(`/item/${prevItem.id}`)} class="group">
            <span class="font-mono text-xs uppercase tracking-widest text-text-dim">Previous</span>
            <p class="text-lg text-text group-hover:text-accent transition-colors">{prevItem.name}</p>
          </a>
        ) : <div />}
        {nextItem ? (
          <a href={url(`/item/${nextItem.id}`)} class="group text-right">
            <span class="font-mono text-xs uppercase tracking-widest text-text-dim">Next</span>
            <p class="text-lg text-text group-hover:text-accent transition-colors">{nextItem.name}</p>
          </a>
        ) : <div />}
      </nav>
    </div>
  </article>
</BaseLayout>
