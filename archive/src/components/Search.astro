---
import { getAllItems, getAllCategories } from '../lib/items';

const base = import.meta.env.BASE_URL || '/';
const items = getAllItems();
const categories = getAllCategories();

const categoryLabels: Record<string, string> = {
  coin: 'Coins',
  jewelry: 'Jewelry',
  ring: 'Rings',
  seal: 'Seals',
  misc: 'Miscellaneous',
};

const popularTags = ['roman', 'greek', 'silver', 'gold', 'ancient'];
const recentItems = items.slice(0, 3);

function url(path: string): string {
  return `${base}${path}`.replace(/\/+/g, '/');
}
---

<div id="search-wrapper" class="search-wrapper">
  <div id="search-loading" class="search-loading">
    <div class="flex items-center gap-3">
      <div class="search-spinner"></div>
      <span class="font-mono text-sm text-text-muted">// Initializing search index...</span>
    </div>
  </div>
  <div id="search" class="search-container" data-base-url={base}></div>

  <!-- Search suggestions (shown when search is empty) -->
  <div id="search-suggestions" class="mt-8 space-y-8">
    <!-- Browse by category -->
    <div>
      <h3 class="font-mono text-xs uppercase tracking-wider text-accent mb-4">// Browse by Category</h3>
      <div class="flex flex-wrap gap-2">
        {categories.map((cat) => (
          <a
            href={url(`/collection?category=${cat}`)}
            class="px-4 py-2 bg-surface-light border border-border rounded-lg font-mono text-sm text-text-muted hover:border-accent hover:text-accent transition-all duration-200"
          >
            {categoryLabels[cat]}
          </a>
        ))}
      </div>
    </div>

    <!-- Popular searches -->
    <div>
      <h3 class="font-mono text-xs uppercase tracking-wider text-accent mb-4">// Popular Searches</h3>
      <div class="flex flex-wrap gap-2">
        {popularTags.map((tag) => (
          <button
            class="search-suggestion-tag px-3 py-1.5 bg-surface border border-border rounded font-mono text-xs text-text-dim hover:border-accent hover:text-accent transition-all duration-200"
            data-search-term={tag}
          >
            {tag}
          </button>
        ))}
      </div>
    </div>

    <!-- Recent items -->
    <div>
      <h3 class="font-mono text-xs uppercase tracking-wider text-accent mb-4">// Recent Items</h3>
      <div class="grid sm:grid-cols-3 gap-4">
        {recentItems.map((item) => (
          <a
            href={url(`/item/${item.id}`)}
            class="glass-panel p-4 hover:border-accent/50 transition-all duration-200 group"
          >
            <span class="font-mono text-[10px] uppercase tracking-wider text-accent">
              {categoryLabels[item.category]}
            </span>
            <p class="text-text group-hover:text-accent transition-colors mt-1">
              {item.name}
            </p>
            <p class="font-mono text-xs text-text-dim mt-1">{item.era}</p>
          </a>
        ))}
      </div>
    </div>
  </div>
</div>

<script>
  let pagefindInitialized = false;

  async function initPagefind() {
    const container = document.getElementById('search');
    const loading = document.getElementById('search-loading');
    const suggestions = document.getElementById('search-suggestions');
    if (!container) return;

    // Skip if already initialized on this container
    if (container.dataset.initialized === 'true') return;

    const baseUrl = container.dataset.baseUrl || '/';

    try {
      // @ts-ignore - Pagefind is loaded at runtime
      const { PagefindUI } = await import('@pagefind/default-ui');
      new PagefindUI({
        element: '#search',
        showSubResults: true,
        showImages: false,
        baseUrl: baseUrl,
        bundlePath: `${baseUrl}${baseUrl.endsWith('/') ? '' : '/'}pagefind/`,
      });
      container.dataset.initialized = 'true';
      if (loading) loading.style.display = 'none';

      // Watch for search input to toggle suggestions and clear button visibility
      setTimeout(() => {
        const searchInput = container.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
        const clearButton = container.querySelector('.pagefind-ui__search-clear') as HTMLButtonElement;

        const updateClearVisibility = () => {
          if (clearButton) {
            clearButton.style.display = searchInput.value.length > 0 ? 'flex' : 'none';
          }
          if (suggestions) {
            suggestions.style.display = searchInput.value.length > 0 ? 'none' : 'block';
          }
        };

        if (searchInput) {
          searchInput.addEventListener('input', updateClearVisibility);
          // Also observe for clear button appearing (Pagefind may add it dynamically)
          const observer = new MutationObserver(() => {
            const btn = container.querySelector('.pagefind-ui__search-clear') as HTMLButtonElement;
            if (btn) {
              btn.style.display = searchInput.value.length > 0 ? 'flex' : 'none';
            }
          });
          observer.observe(container, { childList: true, subtree: true });
          // Initial state
          updateClearVisibility();
        }
      }, 100);
    } catch (e) {
      console.error('Pagefind error:', e);
      if (loading) loading.style.display = 'none';
      container.innerHTML = `
        <div class="glass-panel p-6 text-center">
          <p class="font-mono text-sm text-text-muted mb-2">
            <span class="text-accent">//</span> Search index not available
          </p>
          <p class="text-xs text-text-dim">
            Run <code class="bg-surface-light px-2 py-1 rounded">pnpm build</code> to generate the search index.
          </p>
        </div>
      `;
    }
  }

  function setupSuggestionTags() {
    const tags = document.querySelectorAll('.search-suggestion-tag');
    tags.forEach(tag => {
      tag.addEventListener('click', () => {
        const term = (tag as HTMLElement).dataset.searchTerm;
        const searchInput = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
        if (searchInput && term) {
          searchInput.value = term;
          searchInput.dispatchEvent(new Event('input', { bubbles: true }));
          searchInput.focus();
        }
      });
    });
  }

  // Initialize on first load and after View Transitions navigation
  document.addEventListener('astro:page-load', () => {
    initPagefind();
    setupSuggestionTags();
  });
</script>

<style is:global>
  .search-loading {
    padding: 1rem;
  }

  .search-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(34, 211, 238, 0.2);
    border-top-color: #22d3ee;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .search-container {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #22d3ee;
    --pagefind-ui-text: #e4e4e7;
    --pagefind-ui-background: #12121a;
    --pagefind-ui-border: rgba(255, 255, 255, 0.1);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 12px;
    --pagefind-ui-font: 'JetBrains Mono', 'Fira Code', monospace;
  }

  /* Search form container */
  .pagefind-ui__form {
    position: relative;
  }

  /* Search input wrapper */
  .pagefind-ui__search-input-wrapper {
    position: relative;
  }

  /* Search input */
  .pagefind-ui__search-input {
    width: 100% !important;
    font-size: 15px !important;
    font-family: 'JetBrains Mono', monospace !important;
    padding: 16px 120px 16px 48px !important;
    background: rgba(18, 18, 26, 0.9) !important;
    backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    color: #e4e4e7 !important;
    transition: all 0.3s ease !important;
  }

  .pagefind-ui__search-input::placeholder {
    color: #52525b !important;
    font-family: 'JetBrains Mono', monospace !important;
  }

  .pagefind-ui__search-input:focus {
    border-color: rgba(34, 211, 238, 0.5) !important;
    box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.1), 0 0 30px rgba(34, 211, 238, 0.15) !important;
    outline: none !important;
    background: rgba(18, 18, 26, 0.95) !important;
  }

  /* Custom search icon */
  .pagefind-ui__form::before {
    content: '';
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2322d3ee' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    z-index: 10;
    pointer-events: none;
    opacity: 0.7;
  }

  /* Clear button styling */
  .pagefind-ui__search-clear {
    position: absolute !important;
    right: 12px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    padding: 8px 16px !important;
    background: rgba(34, 211, 238, 0.1) !important;
    border: 1px solid rgba(34, 211, 238, 0.3) !important;
    border-radius: 8px !important;
    color: #22d3ee !important;
    font-family: 'JetBrains Mono', monospace !important;
    font-size: 11px !important;
    font-weight: 500 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
  }

  .pagefind-ui__search-clear:hover {
    background: rgba(34, 211, 238, 0.2) !important;
    border-color: rgba(34, 211, 238, 0.5) !important;
    box-shadow: 0 0 15px rgba(34, 211, 238, 0.2) !important;
  }

  /* Hide default clear text, show custom */
  .pagefind-ui__search-clear {
    font-size: 0 !important;
  }

  .pagefind-ui__search-clear::after {
    content: 'Ã— Clear';
    font-size: 11px !important;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* Results container */
  .pagefind-ui__results-area {
    margin-top: 16px !important;
  }

  /* Individual result */
  .pagefind-ui__result {
    padding: 20px !important;
    background: rgba(18, 18, 26, 0.8) !important;
    backdrop-filter: blur(12px) !important;
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    border-radius: 12px !important;
    margin-bottom: 12px !important;
    transition: all 0.2s ease !important;
  }

  .pagefind-ui__result:hover {
    border-color: rgba(34, 211, 238, 0.4) !important;
    background: rgba(18, 18, 26, 0.9) !important;
    box-shadow: 0 0 20px rgba(34, 211, 238, 0.1) !important;
  }

  .pagefind-ui__result-link {
    font-family: 'Space Grotesk', system-ui, sans-serif !important;
    font-size: 18px !important;
    font-weight: 500 !important;
    color: #e4e4e7 !important;
    text-decoration: none !important;
    transition: color 0.2s ease !important;
  }

  .pagefind-ui__result-link:hover {
    color: #22d3ee !important;
  }

  .pagefind-ui__result-title {
    font-weight: 500 !important;
    margin-bottom: 8px !important;
  }

  .pagefind-ui__result-excerpt {
    font-size: 14px !important;
    line-height: 1.6 !important;
    color: #8a8a99 !important;
    font-family: 'Space Grotesk', system-ui, sans-serif !important;
  }

  .pagefind-ui__result-excerpt mark {
    background: rgba(34, 211, 238, 0.2) !important;
    color: #22d3ee !important;
    padding: 1px 4px !important;
    border-radius: 3px !important;
  }

  /* Message styling */
  .pagefind-ui__message {
    color: #8a8a99 !important;
    font-family: 'JetBrains Mono', monospace !important;
    font-size: 13px !important;
    padding: 16px !important;
    text-align: center !important;
  }

  /* Results count */
  .pagefind-ui__results-area > p {
    font-family: 'JetBrains Mono', monospace !important;
    font-size: 12px !important;
    color: #8a8a99 !important;
    margin-bottom: 16px !important;
    padding-left: 4px !important;
  }

  .pagefind-ui__results-area > p::before {
    content: '// ';
    color: #22d3ee;
  }

  /* Suppress default button styling */
  .pagefind-ui__button {
    background: rgba(34, 211, 238, 0.1) !important;
    border: 1px solid rgba(34, 211, 238, 0.3) !important;
    border-radius: 8px !important;
    color: #22d3ee !important;
    font-family: 'JetBrains Mono', monospace !important;
    font-size: 12px !important;
    padding: 10px 20px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
  }

  .pagefind-ui__button:hover {
    background: rgba(34, 211, 238, 0.2) !important;
    border-color: rgba(34, 211, 238, 0.5) !important;
  }
</style>
